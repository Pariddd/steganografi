<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Steganografi - Sembunyikan Pesan</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-950 min-h-screen p-4 text-slate-100">
    <div class="max-w-4xl mx-auto">
      <div
        class="bg-slate-900 rounded-2xl shadow-2xl overflow-hidden border border-slate-800"
      >
        <div class="bg-slate-900 text-white p-6 border-b border-slate-800">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <svg
                class="w-8 h-8"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                />
              </svg>
              <div>
                <h1 class="text-2xl font-bold">Aplikasi Steganografi</h1>
                <p class="text-slate-300 text-sm">
                  A2 - Kriptografi dan Steganografi | UNIMAL
                </p>
              </div>
            </div>
            <a
              href="index.html"
              class="flex items-center gap-2 px-4 py-2 text-sm font-medium bg-blue-500 hover:bg-blue-400 rounded-lg transition-colors duration-300"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 12l9-9 9 9M4 10v10a1 1 0 001 1h4m10-11v11a1 1 0 01-1 1h-4"
                />
              </svg>
              Home
            </a>
          </div>
        </div>

        <div class="flex border-b border-slate-800 bg-slate-900">
          <button
            id="encodeTab"
            class="tab-btn flex-1 py-4 px-6 font-semibold transition-colors bg-slate-800 text-blue-400 border-b-2 border-blue-500"
          >
            <div class="flex items-center justify-center gap-2">
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                />
              </svg>
              Sembunyikan Pesan
            </div>
          </button>
          <button
            id="decodeTab"
            class="tab-btn flex-1 py-4 px-6 font-semibold transition-colors text-slate-400 hover:bg-slate-800"
          >
            <div class="flex items-center justify-center gap-2">
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"
                />
              </svg>
              Ekstrak Pesan
            </div>
          </button>
        </div>

        <div class="p-6 bg-slate-900">
          <div id="encodeSection" class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-slate-200 mb-2"
                >Pesan Rahasia</label
              >
              <textarea
                id="secretMessage"
                placeholder="Masukkan pesan yang ingin disembunyikan..."
                class="w-full h-32 px-4 py-3 border-2 border-slate-700 rounded-lg bg-slate-800 text-slate-100 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none resize-none"
              ></textarea>
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-200 mb-2"
                >Password (Opsional)</label
              >
              <input
                type="password"
                id="encodePassword"
                placeholder="Password untuk enkripsi pesan"
                class="w-full px-4 py-3 border-2 border-slate-700 rounded-lg bg-slate-800 text-slate-100 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none"
              />
            </div>

            <div
              id="encodeDropZone"
              class="border-3 border-dashed border-slate-700 bg-slate-800 rounded-xl p-8 transition-all cursor-pointer hover:border-blue-500 hover:bg-slate-800/80"
            >
              <input
                type="file"
                id="encodeFileInput"
                accept="image/*,audio/*,.pdf,.doc,.docx,.txt"
                class="hidden"
              />
              <div id="encodeFilePreview" class="text-center">
                <svg
                  class="w-16 h-16 text-slate-500 mx-auto mb-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                  />
                </svg>
                <p class="text-slate-100 font-semibold mb-1">
                  Drag & Drop file atau
                </p>
                <button
                  id="encodeSelectBtn"
                  class="text-blue-400 hover:text-blue-300 font-semibold"
                >
                  Pilih File
                </button>
                <p class="text-xs text-slate-500 mt-2">
                  Mendukung: Gambar (PNG, JPG), Audio, PDF, Dokumen
                </p>
              </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3">
              <button
                id="encodeBtn"
                class="flex-1 bg-emerald-600 text-white py-3 rounded-lg font-semibold hover:bg-emerald-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                  />
                </svg>
                Sembunyikan Pesan
              </button>
              <button
                id="clearEncodeBtn"
                class="px-4 py-3 rounded-lg bg-red-600 text-white hover:bg-red-700 text-sm font-medium shadow-md hover:shadow-lg"
              >
                Clear All
              </button>
            </div>

            <div
              id="encodeResult"
              class="hidden mt-6 bg-emerald-900/30 border-2 border-emerald-600/60 rounded-lg p-4"
            >
              <div class="flex items-center justify-between gap-4">
                <div>
                  <p class="font-semibold text-emerald-300">
                    âœ“ Pesan Berhasil Disembunyikan!
                  </p>
                  <p class="text-sm text-emerald-200 mt-1">
                    File siap didownload
                  </p>
                </div>
                <button
                  id="downloadEncoded"
                  class="bg-emerald-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-emerald-600 transition-all flex items-center gap-2"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                    />
                  </svg>
                  Download
                </button>
              </div>
            </div>
          </div>

          <div id="decodeSection" class="space-y-4 hidden">
            <div>
              <label class="block text-sm font-semibold text-slate-200 mb-2"
                >Password (Jika dienkripsi)</label
              >
              <input
                type="password"
                id="decodePassword"
                placeholder="Masukkan password jika pesan dienkripsi"
                class="w-full px-4 py-3 border-2 border-slate-700 rounded-lg bg-slate-800 text-slate-100 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none"
              />
            </div>

            <div
              id="decodeDropZone"
              class="border-3 border-dashed border-slate-700 bg-slate-800 rounded-xl p-8 transition-all cursor-pointer hover:border-blue-500 hover:bg-slate-800/80"
            >
              <input
                type="file"
                id="decodeFileInput"
                accept="image/*,audio/*,.pdf,.doc,.docx,.txt"
                class="hidden"
              />
              <div id="decodeFilePreview" class="text-center">
                <svg
                  class="w-16 h-16 text-slate-500 mx-auto mb-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                  />
                </svg>
                <p class="text-slate-100 font-semibold mb-1">
                  Drag & Drop file atau
                </p>
                <button
                  id="decodeSelectBtn"
                  class="text-blue-400 hover:text-blue-300 font-semibold"
                >
                  Pilih File
                </button>
                <p class="text-xs text-slate-500 mt-2">
                  Upload file yang berisi pesan tersembunyi
                </p>
              </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3">
              <button
                id="decodeBtn"
                class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"
                  />
                </svg>
                Ekstrak Pesan Tersembunyi
              </button>
              <button
                id="clearDecodeBtn"
                class="px-4 py-3 rounded-lg bg-red-600 text-white hover:bg-red-700 text-sm font-medium shadow-md hover:shadow-lg"
              >
                Clear All
              </button>
            </div>

            <div id="decodeResult" class="hidden mt-6">
              <label class="block text-sm font-semibold text-slate-200 mb-2"
                >Pesan yang Ditemukan:</label
              >
              <div
                class="bg-slate-800 border-2 border-blue-600/60 rounded-lg p-4"
              >
                <p
                  id="extractedMessage"
                  class="text-slate-100 whitespace-pre-wrap break-words"
                ></p>
              </div>
              <button
                id="copyMessage"
                class="mt-3 text-sm text-blue-400 hover:text-blue-300 font-semibold flex items-center gap-1"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                  />
                </svg>
                Salin Pesan
              </button>
            </div>
          </div>
        </div>

        <div class="bg-slate-900 px-6 py-4 border-t border-slate-800">
          <p class="text-xs text-slate-500 text-center">
            Farid Kurniawan - Abdul Muzakky - Nuafal Aziz Mulyono - Ahmat Fahri
            Matondang
          </p>
        </div>
      </div>
    </div>

    <script>
      let currentMode = "encode";
      let selectedEncodeFile = null;
      let selectedDecodeFile = null;
      let encodedBlob = null;

      const encodeFileInput = document.getElementById("encodeFileInput");
      const decodeFileInput = document.getElementById("decodeFileInput");
      const encodeFilePreview = document.getElementById("encodeFilePreview");
      const decodeFilePreview = document.getElementById("decodeFilePreview");

      const initialEncodePreviewHTML = `
        <svg
          class="w-16 h-16 text-slate-500 mx-auto mb-3"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
          />
        </svg>
        <p class="text-slate-100 font-semibold mb-1">
          Drag & Drop file atau
        </p>
        <button
          id="encodeSelectBtn"
          class="text-blue-400 hover:text-blue-300 font-semibold"
        >
          Pilih File
        </button>
        <p class="text-xs text-slate-500 mt-2">
          Mendukung: Gambar (PNG, JPG), Audio, PDF, Dokumen
        </p>
      `;

      const initialDecodePreviewHTML = `
        <svg
          class="w-16 h-16 text-slate-500 mx-auto mb-3"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
          />
        </svg>
        <p class="text-slate-100 font-semibold mb-1">
          Drag & Drop file atau
        </p>
        <button
          id="decodeSelectBtn"
          class="text-blue-400 hover:text-blue-300 font-semibold"
        >
          Pilih File
        </button>
        <p class="text-xs text-slate-500 mt-2">
          Upload file yang berisi pesan tersembunyi
        </p>
      `;

      document.getElementById("encodeTab").addEventListener("click", () => {
        currentMode = "encode";
        document.getElementById("encodeSection").classList.remove("hidden");
        document.getElementById("decodeSection").classList.add("hidden");
        document
          .getElementById("encodeTab")
          .classList.add(
            "bg-slate-800",
            "text-blue-400",
            "border-b-2",
            "border-blue-500"
          );
        document
          .getElementById("encodeTab")
          .classList.remove("text-slate-400", "hover:bg-slate-800");
        document
          .getElementById("decodeTab")
          .classList.remove(
            "bg-slate-800",
            "text-blue-400",
            "border-b-2",
            "border-blue-500"
          );
        document
          .getElementById("decodeTab")
          .classList.add("text-slate-400", "hover:bg-slate-800");
      });

      document.getElementById("decodeTab").addEventListener("click", () => {
        currentMode = "decode";
        document.getElementById("encodeSection").classList.add("hidden");
        document.getElementById("decodeSection").classList.remove("hidden");
        document
          .getElementById("decodeTab")
          .classList.add(
            "bg-slate-800",
            "text-blue-400",
            "border-b-2",
            "border-blue-500"
          );
        document
          .getElementById("decodeTab")
          .classList.remove("text-slate-400", "hover:bg-slate-800");
        document
          .getElementById("encodeTab")
          .classList.remove(
            "bg-slate-800",
            "text-blue-400",
            "border-b-2",
            "border-blue-500"
          );
        document
          .getElementById("encodeTab")
          .classList.add("text-slate-400", "hover:bg-slate-800");
      });

      function hashPassword(pwd) {
        let hash = 0;
        for (let i = 0; i < pwd.length; i++) {
          hash = (hash << 5) - hash + pwd.charCodeAt(i);
          hash = hash & hash;
        }
        return Math.abs(hash);
      }

      function encryptMessage(msg, pwd) {
        if (!pwd) return msg;
        const hash = hashPassword(pwd);
        let encrypted = "";
        for (let i = 0; i < msg.length; i++) {
          encrypted += String.fromCharCode(msg.charCodeAt(i) ^ hash % 256);
        }
        return btoa(encrypted);
      }

      function decryptMessage(encrypted, pwd) {
        if (!pwd) return encrypted;
        try {
          const decoded = atob(encrypted);
          const hash = hashPassword(pwd);
          let decrypted = "";
          for (let i = 0; i < decoded.length; i++) {
            decrypted += String.fromCharCode(
              decoded.charCodeAt(i) ^ hash % 256
            );
          }
          return decrypted;
        } catch (e) {
          return null;
        }
      }

      function encodeMessageToImage(file, message, password) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          const reader = new FileReader();

          reader.onload = (e) => {
            img.onload = () => {
              const canvas = document.createElement("canvas");
              const ctx = canvas.getContext("2d");
              canvas.width = img.width;
              canvas.height = img.height;
              ctx.drawImage(img, 0, 0);

              const imageData = ctx.getImageData(
                0,
                0,
                canvas.width,
                canvas.height
              );
              const data = imageData.data;

              const finalMessage = password
                ? encryptMessage(message, password)
                : message;
              const messageWithDelimiter = finalMessage + "###END###";

              let binaryMessage = "";
              for (let i = 0; i < messageWithDelimiter.length; i++) {
                const binary = messageWithDelimiter
                  .charCodeAt(i)
                  .toString(2)
                  .padStart(8, "0");
                binaryMessage += binary;
              }

              if (binaryMessage.length > data.length / 4) {
                reject(
                  "Gambar terlalu kecil untuk menyimpan pesan ini. Gunakan gambar yang lebih besar."
                );
                return;
              }

              for (let i = 0; i < binaryMessage.length; i++) {
                data[i * 4] = (data[i * 4] & 0xfe) | parseInt(binaryMessage[i]);
              }

              ctx.putImageData(imageData, 0, 0);
              canvas.toBlob((blob) => {
                resolve(blob);
              }, "image/png");
            };
            img.onerror = () => reject("Gagal memuat gambar");
            img.src = e.target.result;
          };

          reader.onerror = () => reject("Gagal membaca file");
          reader.readAsDataURL(file);
        });
      }

      function decodeMessageFromImage(file, password) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          const reader = new FileReader();

          reader.onload = (e) => {
            img.onload = () => {
              const canvas = document.createElement("canvas");
              const ctx = canvas.getContext("2d");
              canvas.width = img.width;
              canvas.height = img.height;
              ctx.drawImage(img, 0, 0);

              const imageData = ctx.getImageData(
                0,
                0,
                canvas.width,
                canvas.height
              );
              const data = imageData.data;

              let binaryMessage = "";
              for (let i = 0; i < data.length / 4; i++) {
                binaryMessage += (data[i * 4] & 1).toString();
              }

              let message = "";
              for (let i = 0; i < binaryMessage.length; i += 8) {
                const byte = binaryMessage.substr(i, 8);
                const charCode = parseInt(byte, 2);
                if (charCode === 0) break;
                message += String.fromCharCode(charCode);
              }

              const delimiterIndex = message.indexOf("###END###");
              if (delimiterIndex === -1) {
                reject("Tidak ditemukan pesan tersembunyi dalam file ini");
                return;
              }

              let extractedMessage = message.substring(0, delimiterIndex);

              if (password) {
                const decrypted = decryptMessage(extractedMessage, password);
                if (decrypted === null) {
                  reject("Password salah atau pesan rusak");
                  return;
                }
                extractedMessage = decrypted;
              }

              resolve(extractedMessage);
            };
            img.onerror = () => reject("Gagal memuat gambar");
            img.src = e.target.result;
          };

          reader.onerror = () => reject("Gagal membaca file");
          reader.readAsDataURL(file);
        });
      }

      function encodeMessageToBinary(file, message, password) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = (e) => {
            const arrayBuffer = e.target.result;
            const bytes = new Uint8Array(arrayBuffer);

            const finalMessage = password
              ? encryptMessage(message, password)
              : message;
            const messageWithDelimiter = finalMessage + "###END###";

            const messageBytes = new TextEncoder().encode(messageWithDelimiter);

            if (messageBytes.length + 4 > bytes.length) {
              reject("File terlalu kecil untuk menyimpan pesan ini");
              return;
            }

            const newBytes = new Uint8Array(
              bytes.length + messageBytes.length + 4
            );

            new DataView(newBytes.buffer).setUint32(
              0,
              messageBytes.length,
              true
            );

            newBytes.set(messageBytes, 4);

            newBytes.set(bytes, 4 + messageBytes.length);

            const blob = new Blob([newBytes], { type: file.type });
            resolve(blob);
          };

          reader.onerror = () => reject("Gagal membaca file");
          reader.readAsArrayBuffer(file);
        });
      }

      function decodeMessageFromBinary(file, password) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = (e) => {
            const arrayBuffer = e.target.result;
            const bytes = new Uint8Array(arrayBuffer);

            if (bytes.length < 4) {
              reject("File terlalu kecil atau tidak mengandung pesan");
              return;
            }

            const messageLength = new DataView(bytes.buffer).getUint32(0, true);

            if (messageLength > bytes.length - 4) {
              reject("Tidak ditemukan pesan tersembunyi dalam file ini");
              return;
            }

            const messageBytes = bytes.slice(4, 4 + messageLength);
            let message = new TextDecoder().decode(messageBytes);

            const delimiterIndex = message.indexOf("###END###");
            if (delimiterIndex === -1) {
              reject("Tidak ditemukan pesan tersembunyi dalam file ini");
              return;
            }

            let extractedMessage = message.substring(0, delimiterIndex);

            if (password) {
              const decrypted = decryptMessage(extractedMessage, password);
              if (decrypted === null) {
                reject("Password salah atau pesan rusak");
                return;
              }
              extractedMessage = decrypted;
            }

            resolve(extractedMessage);
          };

          reader.onerror = () => reject("Gagal membaca file");
          reader.readAsArrayBuffer(file);
        });
      }

      const encodeDropZone = document.getElementById("encodeDropZone");
      const encodeSelectBtnInit = () =>
        document
          .getElementById("encodeSelectBtn")
          .addEventListener("click", (e) => {
            e.stopPropagation();
            encodeFileInput.click();
          });

      encodeSelectBtnInit();

      encodeDropZone.addEventListener("click", () => {
        if (!selectedEncodeFile) {
          encodeFileInput.click();
        }
      });

      encodeFileInput.addEventListener("change", (e) => {
        if (e.target.files[0]) {
          handleEncodeFile(e.target.files[0]);
        }
      });

      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        encodeDropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      ["dragenter", "dragover"].forEach((eventName) => {
        encodeDropZone.addEventListener(eventName, () => {
          encodeDropZone.classList.add("border-blue-500", "bg-slate-800/80");
        });
      });

      ["dragleave", "drop"].forEach((eventName) => {
        encodeDropZone.addEventListener(eventName, () => {
          encodeDropZone.classList.remove("border-blue-500", "bg-slate-800/80");
        });
      });

      encodeDropZone.addEventListener("drop", (e) => {
        const file = e.dataTransfer.files[0];
        if (file) {
          handleEncodeFile(file);
        }
      });

      function handleEncodeFile(file) {
        selectedEncodeFile = file;
        const fileName =
          file.name.length > 30
            ? file.name.substring(0, 30) + "..."
            : file.name;
        const fileSize = (file.size / 1024).toFixed(2);

        encodeFilePreview.innerHTML = `
        <div class="flex flex-col items-center gap-3">
          <svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <div>
            <p class="font-semibold text-slate-100">${fileName}</p>
            <p class="text-sm text-slate-400">${fileSize} KB</p>
          </div>
          <button id="changeEncodeFile" class="text-sm text-blue-400 hover:text-blue-300 font-semibold">Ganti File</button>
        </div>
      `;

        document
          .getElementById("changeEncodeFile")
          .addEventListener("click", (e) => {
            e.stopPropagation();
            encodeFileInput.click();
          });
      }

      const decodeDropZone = document.getElementById("decodeDropZone");
      const decodeSelectBtnInit = () =>
        document
          .getElementById("decodeSelectBtn")
          .addEventListener("click", (e) => {
            e.stopPropagation();
            decodeFileInput.click();
          });

      decodeSelectBtnInit();

      decodeDropZone.addEventListener("click", () => {
        if (!selectedDecodeFile) {
          decodeFileInput.click();
        }
      });

      decodeFileInput.addEventListener("change", (e) => {
        if (e.target.files[0]) {
          handleDecodeFile(e.target.files[0]);
        }
      });

      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        decodeDropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      ["dragenter", "dragover"].forEach((eventName) => {
        decodeDropZone.addEventListener(eventName, () => {
          decodeDropZone.classList.add("border-blue-500", "bg-slate-800/80");
        });
      });

      ["dragleave", "drop"].forEach((eventName) => {
        decodeDropZone.addEventListener(eventName, () => {
          decodeDropZone.classList.remove("border-blue-500", "bg-slate-800/80");
        });
      });

      decodeDropZone.addEventListener("drop", (e) => {
        const file = e.dataTransfer.files[0];
        if (file) {
          handleDecodeFile(file);
        }
      });

      function handleDecodeFile(file) {
        selectedDecodeFile = file;
        const fileName =
          file.name.length > 30
            ? file.name.substring(0, 30) + "..."
            : file.name;
        const fileSize = (file.size / 1024).toFixed(2);

        decodeFilePreview.innerHTML = `
        <div class="flex flex-col items-center gap-3">
          <svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <div>
            <p class="font-semibold text-slate-100">${fileName}</p>
            <p class="text-sm text-slate-400">${fileSize} KB</p>
          </div>
          <button id="changeDecodeFile" class="text-sm text-blue-400 hover:text-blue-300 font-semibold">Ganti File</button>
        </div>
      `;

        document
          .getElementById("changeDecodeFile")
          .addEventListener("click", (e) => {
            e.stopPropagation();
            decodeFileInput.click();
          });
      }

      document
        .getElementById("encodeBtn")
        .addEventListener("click", async () => {
          const message = document.getElementById("secretMessage").value;
          const password = document.getElementById("encodePassword").value;

          if (!message.trim()) {
            alert("Masukkan pesan yang ingin disembunyikan");
            return;
          }

          if (!selectedEncodeFile) {
            alert("Pilih file untuk menyembunyikan pesan");
            return;
          }

          try {
            document.getElementById("encodeBtn").disabled = true;
            document.getElementById("encodeBtn").innerHTML =
              "<span>Memproses...</span>";

            let blob;
            if (selectedEncodeFile.type.startsWith("image/")) {
              blob = await encodeMessageToImage(
                selectedEncodeFile,
                message,
                password
              );
            } else {
              blob = await encodeMessageToBinary(
                selectedEncodeFile,
                message,
                password
              );
            }

            encodedBlob = blob;
            document.getElementById("encodeResult").classList.remove("hidden");
          } catch (error) {
            alert("Error: " + error);
          } finally {
            document.getElementById("encodeBtn").disabled = false;
            document.getElementById("encodeBtn").innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
          </svg>
          Sembunyikan Pesan
        `;
          }
        });

      document
        .getElementById("downloadEncoded")
        .addEventListener("click", () => {
          if (!encodedBlob) return;

          const url = URL.createObjectURL(encodedBlob);
          const a = document.createElement("a");
          a.href = url;

          const originalName = selectedEncodeFile.name;
          const isImage = selectedEncodeFile.type.startsWith("image/");
          let ext;

          if (isImage) {
            ext = ".png";
          } else {
            const dotIndex = originalName.lastIndexOf(".");
            ext = dotIndex !== -1 ? originalName.slice(dotIndex) : "";
          }

          const baseName = originalName.replace(/\.[^/.]+$/, "");
          a.download = "stego_" + baseName + ext;

          a.click();
          URL.revokeObjectURL(url);
        });

      document
        .getElementById("decodeBtn")
        .addEventListener("click", async () => {
          const password = document.getElementById("decodePassword").value;

          if (!selectedDecodeFile) {
            alert("Pilih file yang berisi pesan tersembunyi");
            return;
          }

          try {
            document.getElementById("decodeBtn").disabled = true;
            document.getElementById("decodeBtn").innerHTML =
              "<span>Mengekstrak pesan...</span>";

            let message;
            if (selectedDecodeFile.type.startsWith("image/")) {
              message = await decodeMessageFromImage(
                selectedDecodeFile,
                password
              );
            } else {
              message = await decodeMessageFromBinary(
                selectedDecodeFile,
                password
              );
            }

            document.getElementById("extractedMessage").textContent = message;
            document.getElementById("decodeResult").classList.remove("hidden");
          } catch (error) {
            alert("Error: " + error);
          } finally {
            document.getElementById("decodeBtn").disabled = false;
            document.getElementById("decodeBtn").innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>
          </svg>
          Ekstrak Pesan Tersembunyi
        `;
          }
        });

      document.getElementById("copyMessage").addEventListener("click", () => {
        const message = document.getElementById("extractedMessage").textContent;
        navigator.clipboard.writeText(message).then(() => {
          const btn = document.getElementById("copyMessage");
          const originalHTML = btn.innerHTML;
          btn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          Tersalin!
        `;
          setTimeout(() => {
            btn.innerHTML = originalHTML;
          }, 2000);
        });
      });

      document
        .getElementById("clearEncodeBtn")
        .addEventListener("click", () => {
          document.getElementById("secretMessage").value = "";
          document.getElementById("encodePassword").value = "";
          selectedEncodeFile = null;
          encodedBlob = null;
          encodeFileInput.value = "";
          encodeFilePreview.innerHTML = initialEncodePreviewHTML;
          encodeSelectBtnInit();
          document.getElementById("encodeResult").classList.add("hidden");
        });

      document
        .getElementById("clearDecodeBtn")
        .addEventListener("click", () => {
          document.getElementById("decodePassword").value = "";
          selectedDecodeFile = null;
          decodeFileInput.value = "";
          decodeFilePreview.innerHTML = initialDecodePreviewHTML;
          decodeSelectBtnInit();
          document.getElementById("decodeResult").classList.add("hidden");
          document.getElementById("extractedMessage").textContent = "";
        });
    </script>
  </body>
</html>
